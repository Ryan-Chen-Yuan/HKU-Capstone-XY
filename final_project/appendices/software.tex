\section{Software and Program Listings}
\label{sec:software}

\subsection{System Architecture Code}

\begin{verbatim}
# Main application structure
app/
├── __init__.py
├── config.py
├── models/
│   ├── __init__.py
│   ├── user.py
│   ├── conversation.py
│   └── assessment.py
├── services/
│   ├── __init__.py
│   ├── chat_service.py
│   ├── emotion_service.py
│   ├── event_service.py
│   └── analysis_service.py
├── api/
│   ├── __init__.py
│   ├── chat_routes.py
│   ├── user_routes.py
│   └── assessment_routes.py
└── utils/
    ├── __init__.py
    ├── ai_utils.py
    └── security.py
\end{verbatim}

\subsection{Key Algorithm Implementation}

\begin{verbatim}
# Emotion analysis algorithm
def analyze_emotion(text):
    """
    Analyze emotional content of user input
    Returns: emotion_score, keywords, sentiment
    """
    # Preprocess text
    processed_text = preprocess_text(text)
    
    # Generate embeddings
    embeddings = model.encode(processed_text)
    
    # Classify emotion
    emotion_score = emotion_classifier.predict(embeddings)
    
    # Extract keywords
    keywords = extract_keywords(processed_text)
    
    return emotion_score, keywords, sentiment

# Event extraction algorithm
def extract_events(conversation_history):
    """
    Extract psychologically significant events from conversation
    Returns: list of events with categories and timestamps
    """
    events = []
    
    for message in conversation_history:
        # Analyze message for event indicators
        event_indicators = analyze_event_indicators(message)
        
        if event_indicators:
            event = {
                'type': classify_event_type(event_indicators),
                'timestamp': message.timestamp,
                'severity': calculate_event_severity(event_indicators),
                'description': generate_event_description(event_indicators)
            }
            events.append(event)
    
    return events

# AI Chatbot response generation
def generate_response(user_input, conversation_context):
    """
    Generate empathetic AI response based on user input and context
    Returns: response_text, safety_flags
    """
    # Analyze user emotional state
    emotion_analysis = analyze_emotion(user_input)
    
    # Check for crisis indicators
    safety_flags = check_crisis_indicators(user_input, emotion_analysis)
    
    # Generate context-aware response
    response_prompt = build_response_prompt(user_input, conversation_context, emotion_analysis)
    response_text = llm_model.generate(response_prompt)
    
    # Apply safety filters
    response_text = apply_safety_filters(response_text, safety_flags)
    
    return response_text, safety_flags

# User profile management
def update_user_profile(user_id, interaction_data):
    """
    Update user profile with new interaction data
    """
    profile = load_user_profile(user_id)
    
    # Update emotional patterns
    profile['emotional_patterns'].append(interaction_data['emotion'])
    
    # Update conversation history
    profile['conversation_history'].append(interaction_data['message'])
    
    # Update assessment data
    if interaction_data.get('assessment'):
        profile['assessments'].append(interaction_data['assessment'])
    
    # Calculate trends
    profile['trends'] = calculate_trends(profile['emotional_patterns'])
    
    save_user_profile(user_id, profile)
\end{verbatim}

\subsection{API Endpoint Implementation}

\begin{verbatim}
# Chat API endpoint
@app.route('/api/chat', methods=['POST'])
def chat_endpoint():
    """
    Handle chat interactions with AI assistant
    """
    try:
        data = request.get_json()
        user_id = data.get('user_id')
        message = data.get('message')
        
        # Load conversation context
        context = load_conversation_context(user_id)
        
        # Generate AI response
        response, safety_flags = generate_response(message, context)
        
        # Update conversation history
        update_conversation_history(user_id, message, response)
        
        # Check for crisis situations
        if safety_flags['crisis_detected']:
            trigger_crisis_protocol(user_id, safety_flags)
        
        return jsonify({
            'response': response,
            'emotion_analysis': analyze_emotion(message),
            'safety_flags': safety_flags
        })
        
    except Exception as e:
        return jsonify({'error': str(e)}), 500

# Mood analysis endpoint
@app.route('/api/mood', methods=['POST'])
def mood_analysis():
    """
    Analyze mood of user messages
    """
    try:
        data = request.get_json()
        message = data.get('message')
        
        emotion_score, keywords, sentiment = analyze_emotion(message)
        
        return jsonify({
            'emotion_score': emotion_score,
            'keywords': keywords,
            'sentiment': sentiment
        })
        
    except Exception as e:
        return jsonify({'error': str(e)}), 500

# Event extraction endpoint
@app.route('/api/events/extract', methods=['POST'])
def extract_events_endpoint():
    """
    Extract psychological events from conversation
    """
    try:
        data = request.get_json()
        conversation_history = data.get('conversation_history')
        
        events = extract_events(conversation_history)
        
        return jsonify({
            'events': events,
            'event_count': len(events)
        })
        
    except Exception as e:
        return jsonify({'error': str(e)}), 500
\end{verbatim} 