# Progress 3 进展报告

## 一、概述

Progress 3 阶段(6月1日 - 6月16日)团队协作完成了以下工作：

1. 「planning」模块开发：根据「perception」->「planing」->「action」工作流，设计并实现「planning」模块，职责是根据当前对话内容，分析来访者的咨询目标，并规划对话策略，存储在 plan 数据结构中，以指导后续生成回复内容。
2. 「情绪感知」模块更新：从单条用户消息的情绪分析扩展为批量消息分析；智能刷新小程序情绪页面的数据；温度计图标高亮提示
3. 新增「引导性提问」和「用户模式分析」两个对话工具，在env中加入两个工具的控制开关，优化对话质量。
4. 「事件提取」模块更新：后端实现异步事件提取机制，并与微信小程序联调。
5. 「langgraph」框架验证：搭建简易对话demo验证报警、记忆等框架能力。

## 二、详细进展

### 「planning」模块开发 - 陈源

- 设计和调试「咨询策略规划」Prompt，目标是：分析用户意图，制定对话策略，更新对话计划。
- 设计 plan 数据结构，要求 LLM 返回指定的 json 返回，并存储在本地文件中。
- 基于 plan 结果，指导对话生成（action）模块生成回复给用户的消息。

新增 planning 后的对话案例如下

<img width="562" alt="Code 2025-06-15 21 04 28" src="https://github.com/user-attachments/assets/0e1761e3-920a-4521-b5e5-89e09dbbb72b" />

1. 生成的回复会更有目的性和连贯性
2. 每个step有维护状态，比如「完成」「进行中」「待执行」
3. plan是可迭代的，比如这个case里面一开始只是建议yoga，深呼吸。再聊几轮，model发现时间不够用压力大可能只是表现，而不是深层次的原因，于是会新增一个step，尝试重新定位问题

```json
{
"id": "4",
"type": "问题澄清",
"content": "你愿意跟我分享一下你担心找不到合适岗位的原因吗？",
"status": "待执行"
}
```

### 「情绪感知」模块更新 - 王雪瑶

1. 扩展情绪分析范围
系统在用户每次发送消息后，会自动提取最近 7 条用户消息 进行情绪分析（原先仅分析单条消息）。这一改进能够更全面地捕捉用户近期情绪变化趋势，提升分析的准确性和连续性。

2. 情绪页面数据智能刷新
情绪分析结果（moodData）的更新遵循以下规则：
情绪强度（moodIntensity）大于 0.8，表明当前情绪非常强烈；且
情绪类别（moodCategory）与上一次不同，避免重复刷新无效数据。
这样处理能够减少页面的无意义频繁刷新，同时让用户更直观地感受到显著的情绪变化。

3. 温度计图标高亮提示
当情绪数据发生有效更新时，系统会触发温度计图标高亮/闪烁动画（thermometerIconAnimation），持续约 5 秒，以提醒用户情绪状态的变化。动画结束后，图标恢复常态。这一设计显著增强了用户对情绪变化的感知体验。

### 「引导性提问」和「用户模式分析」对话工具 - 徐翰林

1. 增加引导性提问模块，在对话开始时检测事件的完整程度，通过对话补全事件信息，避免在事件了解不足的情况下给出莫名其妙的建议和问题。
2. 增加用户模式分析模块，在事件前因后果了解清楚后，生成对用户的模式分析文件。后期可将该模式分析结果作为用户可判断的信息卡片放入事件提取页面中。
3. 在env中加入两个工具的控制开关。可以对比开启和关闭后的不同效果。

对话案例：

没有引导性提问时，agent不会关心这件具体的事情的前因后果
<img width="302" alt="image" src="https://github.com/user-attachments/assets/29ac0d61-8e4b-4621-903f-506337c14c8d" />
会问，“还有没有其他人知道你被打了”

加上之后，会问开启对事件本身对关心
<img width="294" alt="image" src="https://github.com/user-attachments/assets/d07e1ed9-d7d9-499f-881c-bc480b693b98" />

开启工具后，对话策略会新增如下流程
<img width="550" alt="image" src="https://github.com/user-attachments/assets/9acbf2b6-0a9d-46b3-b0e5-a87a4662fc45" />

### 「事件提取」模块更新 - 粟英成

1. 事件提取服务与异步机制实现

- 开发事件提取服务（EventService），使用独立的模型，配置 response_format={"type": "json_object"} 确保稳定的json输出

- 在用户对话时集成异步事件提取机制，自动获取最近4条对话内容进行后台处理，无感化提取关键事件

- 采用多模型架构（DeepSeek + Qwen3-32B）分离对话和事件提取任务，避免 Rate Limit 问题

2. 前后端对接与系统集成

- 完成前端事件服务重构，实现真实API调用替换Mock数据，支持会话级事件管理和降级策略

- 集成异步事件提取到主对话流程，用户正常对话时系统自动提取并存储事件，提供无感化的事件记录体验

### 「langgraph」框架验证 - 于易涛

使用 langgraph 框架搭建一个简易的 心理咨询agent，验证长短期记忆库、联网检索、自动报警、外部工具调用能力。

## 三、后续计划

**时间**：6月17日-7月7日

1. 基于 agent 框架（例如 langgraph）或优秀开源项目（例如 OpenManus）重构代码，使项目组织和逻辑更清晰，并集成记忆、联网检索、自动报警、外部工具调用等能力。
   - 「perception」->「planing」->「action」工作流使用框架进行编排
   - 将已有的对话工具作为可被模块调用的 toolkit 进行管理

2. 小程序功能完善和UI优化
   - 完成小程序原型中尚未完全实现的基础功能：登录、个人主页、勋章系统。
   - 完善现有的交互流程和视觉效果，以及更清晰的引导和功能说明，提升用户体验。
